{% extends 'base.html' %}

{% block title %}Panel Principal{% endblock %}

{% block header %}Panel Principal{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card card-primary">
    <div class="card-header">
      <h3 class="card-title">Visor de Token JWT üîç</h3>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label for="jwtInput">Pega aqu√≠ tu token JWT:</label>
        <textarea id="jwtInput" class="form-control" rows="4" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>
      </div>
      <button class="btn btn-primary" onclick="decodeToken()">Decodificar Token</button>

      <div id="error" class="mt-3 text-danger font-weight-bold"></div>

      <table id="resultTable" class="table table-bordered table-striped mt-3" style="display:none;">
        <thead>
          <tr>
            <th>Campo</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function base64UrlDecode(input) {
    let base64 = input.replace(/-/g, '+').replace(/_/g, '/');
    let pad = base64.length % 4;
    if (pad) base64 += '='.repeat(4 - pad);
    try {
      return decodeURIComponent(escape(window.atob(base64)));
    } catch (e) {
      return null;
    }
  }

  function decodeToken() {
    const token = document.getElementById('jwtInput').value.trim();
    const errorDiv = document.getElementById('error');
    const table = document.getElementById('resultTable');
    const tbody = document.getElementById('resultBody');

    errorDiv.textContent = '';
    tbody.innerHTML = '';
    table.style.display = 'none';

    if (!token) {
      errorDiv.textContent = '‚ö†Ô∏è Debes pegar un token JWT.';
      return;
    }

    const parts = token.split('.');
    if (parts.length !== 3) {
      errorDiv.textContent = '‚ùå Token inv√°lido: debe tener 3 partes (header.payload.signature).';
      return;
    }

    const payload = base64UrlDecode(parts[1]);
    if (!payload) {
      errorDiv.textContent = '‚ùå No se pudo decodificar el payload.';
      return;
    }

    try {
      const data = JSON.parse(payload);

      Object.keys(data).forEach(key => {
        let value = data[key];
        if (Array.isArray(value)) value = value.join(', ');
        tbody.innerHTML += `<tr><td>${key}</td><td>${value}</td></tr>`;
      });

      table.style.display = 'table';
    } catch (e) {
      errorDiv.textContent = '‚ùå Error al parsear el payload JSON.';
    }
  }
</script>

{% endblock %}
