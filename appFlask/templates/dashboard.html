{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block active_dashboard %} active {% endblock %}

{% block header %}System Dashboard{% endblock %}

{% block path_main %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}


<div class="row mt-4">
    <!-- User Statistics Chart -->
    <div class="col-md-6">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">User Overview</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="userChart"
                    style="min-height: 250px; height: 250px; max-height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>

    <!-- Rule Distribution Chart -->
    <div class="col-md-6">
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title">Rule Distribution</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="ruleChart"
                    style="min-height: 250px; height: 250px; max-height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Usuarios -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ stats.total_users }}</h3>
                <p>Total Users</p>
            </div>
            <div class="icon"><i class="fas fa-users"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3>{{ stats.total_superusers }}</h3>
                <p>Superusers</p>
            </div>
            <div class="icon"><i class="fas fa-user-shield"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-primary">
            <div class="inner">
                <h3>{{ stats.users_with_keys }}</h3>
                <p>Users with Active Keys</p>
            </div>
            <div class="icon"><i class="fas fa-key"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ stats.active_key_ratio }}%</h3>
                <p>Key Activation Rate</p>
            </div>
            <div class="icon"><i class="fas fa-percentage"></i></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Roles y Grants -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-dark">
            <div class="inner">
                <h3>{{ stats.total_roles }}</h3>
                <p>Total Roles</p>
            </div>
            <div class="icon"><i class="fas fa-user-tag"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-secondary">
            <div class="inner">
                <h3>{{ stats.roles_with_grants }}</h3>
                <p>Roles Linked to Grants</p>
            </div>
            <div class="icon"><i class="fas fa-link"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>{{ stats.total_grants }}</h3>
                <p>Grant Templates</p>
            </div>
            <div class="icon"><i class="fas fa-certificate"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ stats.grant_rules_count }}</h3>
                <p>Rules Linked to Grants</p>
            </div>
            <div class="icon"><i class="fas fa-random"></i></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Dominios, TÃ³picos y Reglas -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-teal">
            <div class="inner">
                <h3>{{ stats.total_domains }}</h3>
                <p>Domains</p>
            </div>
            <div class="icon"><i class="fas fa-globe"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-indigo">
            <div class="inner">
                <h3>{{ stats.total_topics }}</h3>
                <p>Topics</p>
            </div>
            <div class="icon"><i class="fas fa-comments"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-light">
            <div class="inner">
                <h3>{{ stats.total_rules }}</h3>
                <p>Total Rules</p>
            </div>
            <div class="icon"><i class="fas fa-gavel"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-lightblue">
            <div class="inner">
                <h3>{{ stats.rules_with_domains }}</h3>
                <p>Rules with Domains</p>
            </div>
            <div class="icon"><i class="fas fa-network-wired"></i></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-orange">
            <div class="inner">
                <h3>{{ stats.rules_with_topics }}</h3>
                <p>Rules with Topics</p>
            </div>
            <div class="icon"><i class="fas fa-stream"></i></div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const stats = {{ stats | tojson }};

    const userChartCtx = document.getElementById('userChart').getContext('2d');
    new Chart(userChartCtx, {
        type: 'bar',
        data: {
            labels: ['Total Users', 'Superusers', 'Users w/ Keys', 'Active Key Ratio (%)'],
            datasets: [{
                label: 'User Stats',
                data: [
                    stats.total_users,
                    stats.total_superusers,
                    stats.users_with_keys,
                    stats.active_key_ratio
                ],
                backgroundColor: ['#17a2b8', '#ffc107', '#007bff', '#28a745']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'User Overview'
                }
            }
        }
    });

    const ruleChartCtx = document.getElementById('ruleChart').getContext('2d');
    new Chart(ruleChartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Total Rules', 'Rules w/ Domains', 'Rules w/ Topics', 'Grant Rules'],
            datasets: [{
                label: 'Rule Stats',
                data: [
                    stats.total_rules,
                    stats.rules_with_domains,
                    stats.rules_with_topics,
                    stats.grant_rules_count
                ],
                backgroundColor: ['#d3d3d3', '#17a2b8', '#6f42c1', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Rule Distribution'
                }
            }
        }
    });
</script>

{% endblock %}